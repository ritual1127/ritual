<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
  <meta charset="UTF-8">
  <!-- 확대/축소 방지 -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>성적 계산기 & 그래프</title>
  <style>
    /* reset & box-sizing */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    /* 테마 변수 */
    :root {
      --bg: #f2f2f7; --fg: #1c1c1e; --box-bg: rgba(255,255,255,0.8);
      --inp-bg: #fff; --inp-border: #c6c6c8; --primary: #007aff;
    }
    [data-theme="dark"] {
      --bg: #000; --fg: #f2f2f7; --box-bg: rgba(28,28,30,0.8);
      --inp-bg: #1c1c1e; --inp-border: #3a3a3c; --primary: #0a84ff;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
      background: var(--bg); color: var(--fg);
      max-width: 500px; margin: 0 auto;
      padding: env(safe-area-inset-top) 15px 30px env(safe-area-inset-left);
      padding-bottom: env(safe-area-inset-bottom);
    }
    /* 상단 바 */
    .top-bar {
      display: flex; align-items: center; justify-content: space-between;
      margin: 20px 0;
    }
    .top-bar h1 {
      font-size: 28px; font-weight: 600; cursor: pointer;
    }
    .top-controls button {
      background: transparent; color: var(--primary);
      border: 1px solid var(--primary); border-radius: 8px;
      font-size: 14px; height: 30px; line-height: 30px;
      padding: 0 10px; margin-left: 6px; cursor: pointer;
    }
    .top-controls button:active {
      background: rgba(0,122,255,0.1);
    }
    /* 공통 박스 */
    .box {
      background: var(--box-bg); backdrop-filter: blur(20px);
      border-radius: 16px; padding: 20px; margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.6);
    }
    /* 입력 칸 */
    .count-container { display: flex; gap: 12px; }
    .count-container .half { flex: 1; }
    .count-container .half label {
      display: block; font-size: 15px; color: #8e8e93; margin-bottom: 6px;
    }
    .count-container .half input {
      width:100%;height:44px;padding:0 12px;font-size:16px;
      background:var(--inp-bg);border:1px solid var(--inp-border);
      border-radius:10px;color:var(--fg);
    }
    .entry {
      display: grid; grid-template-columns:100px 1fr;
      grid-template-rows:auto auto; column-gap:8px; row-gap:8px;
      align-items:center; margin-bottom:16px;
    }
    .entry label { font-size:15px; color:#8e8e93; }
    .entry input {
      width:100%;height:44px;padding:0 12px;font-size:16px;
      background:var(--inp-bg);border:1px solid var(--inp-border);
      border-radius:10px;color:var(--fg);
    }
    /* 버튼 */
    .btn {
      display:block;width:100%;height:44px;
      font-size:17px;font-weight:600;text-align:center;
      border-radius:12px;margin:12px 0;line-height:44px;
      background:var(--primary);color:#fff;border:none;
      cursor:pointer;
    }
    .btn:active { filter: brightness(0.9); }
    #result {
      font-size:17px;text-align:center;line-height:1.5;
      margin-bottom:20px;
    }
    /* 히스토리 & 테이블 */
    .history-header {
      display:flex;align-items:center;justify-content:space-between;
      margin-bottom:12px;
    }
    .history-header span {
      font-size:17px;font-weight:600;color:var(--fg);
    }
    .history-header .btn-outline {
      font-size:14px;height:30px;line-height:30px;padding:0 10px;
    }
    .table-container {
      background:var(--inp-bg);border-radius:12px;
      overflow-x:auto;box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    .record-table {
      width:100%;border-collapse:collapse;
    }
    .record-table th,
    .record-table td {
      padding:12px 8px;text-align:center;
      font-size:14px;color:#3c3c4399;border:none;
    }
    .record-table thead th {
      color:var(--fg);font-weight:600;
    }
    .record-table tbody tr:nth-child(even) td {
      background:#f2f2f7;
    }
    .record-table tbody tr:hover td {
      background:#e5e5ea;
    }
    .record-table td.subject {
      text-align:left;padding-left:16px;
    }
    .delete-btn {
      color:#ff3b30;cursor:pointer;font-size:14px;
    }
    /* 그래프 뷰 */
    #graphView { display:none; }
    .chart-container {
      background:var(--inp-bg);border-radius:12px;
      padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    @media (max-width:400px) {
      .count-container { flex-direction:column; }
      .entry { grid-template-columns:100% !important; }
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <h1 onclick="showView('calc')">성적 계산기</h1>
    <div class="top-controls">
      <button id="graphBtn">그래프 만들기</button>
      <button id="themeToggle">다크 모드</button>
    </div>
  </div>

  <!-- 계산기 뷰 -->
  <div id="calcView">
    <div class="box">
      <div class="entry">
        <label for="subjectName">과목명</label>
        <input type="text" id="subjectName" placeholder="예: 수학">
      </div>
    </div>
    <div id="countBox" class="box">
      <div class="count-container">
        <div class="half">
          <label for="sCount">수행평가 개수</label>
          <input type="number" id="sCount" value="2" min="1" onchange="generateInputs()">
        </div>
        <div class="half">
          <label for="tCount">지필평가 개수</label>
          <input type="number" id="tCount" value="2" min="1" max="2" onchange="generateInputs()">
        </div>
      </div>
    </div>
    <div id="inputs" class="box"></div>
    <button id="calcBtn" class="btn">계산하기</button>
    <div id="result"></div>
    <div id="history" class="box">
      <div class="history-header">
        <span>계산 기록</span>
        <button id="resetBtn" class="btn-outline">전체 리셋</button>
      </div>
      <div class="table-container">
        <table class="record-table">
          <thead>
            <tr>
              <th>일시</th><th>과목<br>명</th><th>최종<br>점수</th>
              <th>등급</th><th>다음<br>등급<br>필요<br>점수</th>
              <th>떨어질<br>기준</th><th>삭<br>제</th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 그래프 뷰 -->
  <div id="graphView">
    <div class="history-header">
      <span>내 성적 그래프</span>
      <button onclick="showView('calc')" class="btn-outline">뒤로</button>
    </div>
    <div class="chart-container">
      <canvas id="gradeChart"></canvas>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // 다크모드
    const themeToggle = document.getElementById('themeToggle');
    function applyTheme(t) {
      document.documentElement.setAttribute('data-theme', t);
      themeToggle.textContent = t==='light' ? '다크 모드' : '라이트 모드';
      localStorage.setItem('theme', t);
    }
    const saved = localStorage.getItem('theme')||'light';
    applyTheme(saved);
    themeToggle.onclick = ()=> applyTheme(document.documentElement.getAttribute('data-theme')==='light'?'dark':'light');

    // 뷰 전환
    function showView(v){
      document.getElementById('calcView').style.display = v==='calc'?'block':'none';
      document.getElementById('graphView').style.display = v==='graph'?'block':'none';
      if(v==='graph') drawChart();
    }
    document.getElementById('graphBtn').onclick = ()=> showView('graph');

    // --- 기존 계산기 로직 ---
    function generateInputs(){
      const sCnt=+sCount.value, tCnt=+tCount.value;
      let html='<h2>수행평가</h2>';
      for(let i=0;i<sCnt;i++){
        html+=`<div class="entry">
          <label>수행${i+1}</label>
          <input type="number" id="s${i}" placeholder="점수">
          <label>비중(%)</label>
          <input type="number" id="sw${i}" placeholder="%">
        </div>`;
      }
      html+='<h2>지필평가</h2>';
      for(let i=0;i<tCnt;i++){
        let label=tCnt===1?'기말고사':(i===0?'중간고사':'기말고사');
        html+=`<div class="entry">
          <label>${label}</label>
          <input type="number" id="t${i}" placeholder="점수">
          <label>비중(%)</label>
          <input type="number" id="tw${i}" placeholder="%">
        </div>`;
      }
      inputs.innerHTML=html;
    }
    function loadHistory(){
      const raw=localStorage.getItem('gradeHistory');
      return raw?JSON.parse(raw):[];
    }
    function saveHistory(e){
      const h=loadHistory(); h.unshift(e);
      localStorage.setItem('gradeHistory',JSON.stringify(h.slice(0,50)));
    }
    function deleteHistory(i){
      const h=loadHistory(); h.splice(i,1);
      localStorage.setItem('gradeHistory',JSON.stringify(h));
      renderHistory();
    }
    function renderHistory(){
      const tbody=historyBody; tbody.innerHTML='';
      loadHistory().forEach((it,idx)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${it.time}</td>
          <td class="subject">${it.subject}</td>
          <td>${it.final}</td>
          <td><strong style="color:${{A:'#2ecc71',B:'#007aff',C:'#ffcc00',D:'#ff9500',E:'#ff3b30'}[it.grade]}">${it.grade}</strong></td>
          <td>${it.nextMsg}</td><td>${it.dropMsg}</td>
          <td><div class="delete-btn" onclick="deleteHistory(${idx})">삭제</div></td>`;
        tbody.appendChild(tr);
      });
    }
    function calculate(){
      const subject=subjectName.value||'-';
      let sSum=0,wSum=0,mid=0,finalW=0,tSum=0;
      for(let i=0;i<+sCount.value;i++){
        const sc=+document.getElementById(`s${i}`).value||0;
        const w=+document.getElementById(`sw${i}`).value||0;
        sSum+=sc*(w/100); wSum+=w;
      }
      for(let i=0;i<+tCount.value;i++){
        const sc=+document.getElementById(`t${i}`).value||0;
        const w=+document.getElementById(`tw${i}`).value||0;
        if(+tCount.value===1||i===+tCount.value-1) finalW=w/100;
        else mid+=sc*(w/100);
        tSum+=sc*(w/100); wSum+=w;
      }
      if(wSum!==100){
        result.textContent=`❗ 총 비중이 100%가 아닙니다 (현재 ${wSum}%).`;
        return;
      }
      const final=+(sSum+tSum).toFixed(2);
      const grade= final>=90?'A': final>=80?'B': final>=70?'C': final>=60?'D':'E';
      const nextTh={A:null,B:90,C:80,D:70,E:60}[grade];
      const currTh={A:90,B:80,C:70,D:60,E:0}[grade];
      let nextMsg,dropMsg;
      if(nextTh){
        const need=(nextTh-sSum-mid)/finalW;
        const nG={90:'A',80:'B',70:'C',60:'D'}[nextTh];
        nextMsg=need>100?`${nG} 등급 불가`:`${nG} 위해 ${need.toFixed(2)}점↑`;
      } else nextMsg='최고 등급!';
      const drop=(currTh-0.01-sSum-mid)/finalW;
      if(drop<0) dropMsg='떨어질 등급 없음';
      else {
        const dG={90:'B',80:'C',70:'D',60:'E'}[currTh];
        dropMsg=`${drop.toFixed(2)}점↓ (이하 ${dG})`;
      }
      result.innerHTML=`최종: <strong>${final}점</strong><br>${grade} 등급<br>${nextMsg}<br>${dropMsg}`;
      saveHistory({ time:new Date().toLocaleString('ko-KR'), subject, final, grade, nextMsg, dropMsg });
      renderHistory();
    }
    // 초기화
    window.onload = ()=>{
      generateInputs(); renderHistory();
      calcBtn.onclick=calculate;
      resetBtn.onclick=()=>{
        if(confirm('계산 기록을 모두 삭제하시겠습니까?')){
          localStorage.removeItem('gradeHistory'); renderHistory();
        }
      };
    };

    // 그래프 그리기
    let chart;
    function drawChart(){
      const hist = loadHistory().slice().reverse();
      const labels = hist.map(e=>e.time);
      const data   = hist.map(e=>parseFloat(e.final));
      if(chart) chart.destroy();
      const ctx = document.getElementById('gradeChart').getContext('2d');
      chart = new Chart(ctx, {
        type:'line',
        data:{ labels, datasets:[{
          label:'최종 점수',
          data, borderColor:'var(--primary)',
          backgroundColor:'rgba(0,122,255,0.2)',
          fill:true, tension:0.2, pointRadius:4
        }]},
        options:{
          scales:{
            x:{ ticks:{ color:'var(--fg)' }, grid:{ color:'rgba(0,0,0,0.05)' } },
            y:{ suggestedMin:0, suggestedMax:100,
                ticks:{ color:'var(--fg)' }, grid:{ color:'rgba(0,0,0,0.05)' } }
          },
          plugins:{ legend:{ labels:{ color:'var(--fg)' } } }
        }
      });
    }
  </script>
</body>
</html>