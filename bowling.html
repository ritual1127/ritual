<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ë³¼ë§ ë‚´ê¸° ì ìˆ˜íŒ (ëª¨ë°”ì¼ v9)</title>
<style>
  :root{
    --bg:#f7fafc; --card:#ffffff; --muted:#eef2f7; --text:#0f172a; --sub:#64748b;
    --accent:#5b9df9; --good:#16a34a; --bad:#ef4444;
    --shadow:0 12px 24px rgba(15,23,42,.08); --radius:18px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: ui-sans-serif, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", Roboto, "Segoe UI", Arial;
    background:linear-gradient(180deg,#f9fbff, #f2f5fb 40%, #eef2ff);
    color:var(--text);
  }
  .wrap{max-width:980px;margin:0 auto;padding:14px;display:grid;gap:14px}
  @media(min-width:900px){ .wrap{grid-template-columns:1fr .9fr} }
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
  .head{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px}
  .title{font-size:18px;font-weight:800}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .field{display:flex;flex-direction:column;gap:6px;flex:1;min-width:140px}
  label{font-size:12px;color:var(--sub);font-weight:700}
  select,input[type="number"]{width:100%;padding:12px;border-radius:12px;border:1px solid #e5e7eb;background:#fbfcff;font-size:15px}
  .btn{appearance:none;border:0;border-radius:14px;padding:12px 14px;background:#eef2ff;color:#1f2937;font-weight:800;cursor:pointer;transition:.15s;box-shadow: inset 0 -2px 0 rgba(0,0,0,.05)}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:var(--accent);color:white}
  .btn.ghost{background:transparent;border:1px solid #e5e7eb}
  .btn.small{padding:8px 10px;border-radius:12px;font-size:13px}
  .stack{display:grid;gap:10px}
  .muted{color:var(--sub)}

  .table-wrap{overflow:auto;border-radius:14px;border:1px solid #e5e7eb}
  table{width:100%;border-collapse:separate;border-spacing:0;background:white}
  th,td{padding:10px 10px;border-bottom:1px solid #eef1f6;text-align:center;white-space:nowrap}
  thead th{position:sticky;top:0;background:#f7f9ff;color:#334155;font-size:13px;z-index:1}
  tbody tr:hover{background:#fafcff}

  .badge{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:800}
  .badge.A{background:#eaf6ff;color:#1e40af}
  .badge.B{background:#ffecec;color:#7f1d1d}
  .rank{width:28px;height:28px;border-radius:8px;display:inline-grid;place-items:center;font-weight:900;background:#eef2ff}

  .list{display:grid;gap:10px}
  .line{display:flex;justify-content:space-between;align-items:center;background:var(--muted);border-radius:12px;padding:10px}
  .name{font-weight:900}
  .sub{font-size:12px;color:#6b7280}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;font-size:12px;font-weight:800}
  .pill.info{background:#eaf2ff;color:#1e3a8a}
  .pill.good{background:#e8f7ee;color:#166534}
  .pill.bad{background:#ffe8e8;color:#7f1d1d}

  .row-win{background:#f0fff4}
  .row-lose{background:#fff5f5}
  .row-tie{background:#f8fafc}

  .toolbar{
    position:sticky; bottom:0; z-index:3; display:flex; gap:8px; flex-wrap:wrap;
    background:rgba(255,255,255,.85); backdrop-filter: blur(10px);
    padding:10px; border:1px solid #e5e7eb; border-radius:14px; box-shadow:var(--shadow)
  }
  .toolbar .btn{flex:1}

  .hidden{display:none}

  /* íŒ€ì „ ì´ë¦„ ì…ë ¥ ì„¹ì…˜ */
  .team-grid{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:700px){ .team-grid{grid-template-columns:1fr 1fr} }
  .team-col{border:1px solid #e5e7eb;border-radius:12px;padding:10px}
  .team-col h4{margin:0 0 8px 0;font-size:14px}

  /* ê°œì¸ì „ì¼ ë•Œ íŒ€ ì˜ì—­ ì™„ì „ ìˆ¨ê¹€(ìš°ì„ ìˆœìœ„ ê°•ì œ) */
  .team-grid.hidden, #nameFieldsTeam.hidden { display: none !important; }
</style>
</head>
<body>

<!-- ===== ì„¤ì • í™”ë©´ ===== -->
<div id="setupScreen" class="wrap">
  <div class="card">
    <div class="head">
      <div class="title">ì„¤ì •</div>
    </div>

    <div class="stack">
      <div class="row">
        <div class="field">
          <label>ëª¨ë“œ</label>
          <select id="mode">
            <option value="solo">ê°œì¸ì „</option>
            <option value="team">íŒ€ì „ (2íŒ€)</option>
          </select>
        </div>
        <div class="field">
          <label>ì¸ì› ìˆ˜</label>
          <input id="playerCount" type="number" min="2" max="16" value="6">
        </div>
        <div class="field">
          <label>ë¼ìš´ë“œ ìˆ˜</label>
          <input id="roundCount" type="number" min="1" max="10" value="3">
        </div>
      </div>

      <!-- ê°œì¸ì „: í•˜ìœ„ ì¸ì›ë§Œ -->
      <div class="row" id="soloPenaltyRow">
        <div class="field">
          <label>í•˜ìœ„ ì¸ì›(ëˆ ë‚´ëŠ” ì‚¬ëŒ ìˆ˜)</label>
          <input id="bottomPayCount" type="number" min="1" value="2">
        </div>
      </div>

      <!-- íŒ€ì „ ì˜µì…˜ -->
      <div class="row hidden" id="teamPenaltyRow">
        <div class="field">
          <label>íŒ€ì „ 1ì¸ë‹¹ ë²Œê¸ˆ(ì›)</label>
          <input id="teamFinePerPerson" type="number" min="0" step="1000" value="5000">
        </div>
        <div class="field">
          <label>í•¸ë””ìº¡(ì‘ì€ íŒ€ ê°€ì‚°ì )</label>
          <input id="teamHandicap" type="number" min="0" step="1" value="0">
        </div>
        <div class="field" style="align-self:flex-end">
          <button id="randomTeamsBtn" class="btn">íŒ€ ëœë¤ ë°°ì •</button>
        </div>
      </div>

      <!-- ì´ë¦„ ì„ íƒ -->
      <div class="card" style="padding:12px;margin:6px 0">
        <!-- ê°œì¸ì „ -->
        <div id="nameFieldsSolo" class="row"></div>

        <!-- íŒ€ì „: A/B íŒ€ ì¹¼ëŸ¼ -->
        <div id="nameFieldsTeam" class="team-grid hidden">
          <div class="team-col">
            <h4>AíŒ€</h4>
            <div id="teamAFields" class="row"></div>
          </div>
          <div class="team-col">
            <h4>BíŒ€</h4>
            <div id="teamBFields" class="row"></div>
          </div>
        </div>
      </div>

      <div class="row">
        <button id="toGameBtn" class="btn primary">ì„¤ì • í™•ì¸</button>
        <button id="resetSetupBtn" class="btn ghost">ì´ˆê¸°í™”</button>
      </div>
    </div>
  </div>
</div>

<!-- ===== ê²½ê¸° í™”ë©´ ===== -->
<div id="gameScreen" class="wrap hidden">
  <div class="card">
    <div class="head">
      <div class="title">ë³¼ë§ ë‚´ê¸° ì ìˆ˜íŒ</div>
      <div class="row">
        <button id="backToSetupBtn" class="btn ghost small">ì„¤ì • ë‹¤ì‹œí•˜ê¸°</button>
        <button id="resetScoresBtn" class="btn ghost small">ì ìˆ˜ ì´ˆê¸°í™”</button>
      </div>
    </div>

    <!-- ì ìˆ˜íŒ -->
    <div class="table-wrap">
      <table id="scoreTable"></table>
    </div>

    <div class="toolbar">
      <button id="toggleResultBtn" class="btn">ê²°ê³¼ ë³´ê¸°(ìˆœìœ„+ì •ì‚°)</button>
      <button id="saveResultJpgBtn" class="btn primary" disabled>ê²°ê³¼ ì´ë¯¸ì§€ ì €ì¥(JPG)</button>
    </div>
  </div>

  <!-- ê²°ê³¼ íŒ¨ë„(ìˆœìœ„ + ì •ì‚° + ì´ì²´ ì•ˆë‚´ í† ê¸€) -->
  <div id="resultCard" class="card hidden">
    <div class="head">
      <div class="title">ê²°ê³¼</div>
      <div class="row">
        <button id="toggleTransferBtn" class="btn small">ì´ì²´ ì•ˆë‚´ ë³´ê¸°</button>
      </div>
    </div>

    <div id="liveList" class="list" style="margin-bottom:10px"></div>
    <hr style="border:none;border-top:1px solid #e5e7eb;margin:8px 0">
    <div>
      <div class="title" style="font-size:16px;margin-bottom:6px">ì •ì‚°</div>
      <div class="sub" id="settleInfo"></div>
      <div id="settleList" class="list" style="margin-top:8px"></div>
    </div>

    <div id="transferSection" class="hidden">
      <hr style="border:none;border-top:1px solid #e5e7eb;margin:8px 0">
      <div>
        <div class="title" style="font-size:16px;margin-bottom:6px">ê³„ì¢Œ ì´ì²´ ì•ˆë‚´</div>
        <div id="transferList" class="list"></div>
      </div>
    </div>

    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button id="closeResultBtn" class="btn small">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<!-- html2canvas -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
  // ===== ê·œì¹™ ìƒìˆ˜ =====
  // ê°œì¸ì „: ìŠ¹ì(ìƒìœ„)ëŠ” 1ì¸ë‹¹ +5,000ì› ê³ ì •
  const SOLO_WINNER_BONUS = 5000;

  // ===== í”„ë¦¬ì…‹ ì´ë¦„ =====
  const PRESET_NAMES = ["ê¹€ë¬´ì„±","ê¹€ìŠ¹ì¤€","ë°•ì‹ í›„","ë°•ì§€ì™„","ì†ê´‘ë•","ì€ëŒ€ê·œ","ì´ì›ì§„","ì¡°ì„¸ê¸°","ìµœë¯¼ì¬","ìµœìš°ì˜","ìµœì§€í˜¸"];

  // ===== ìƒíƒœ =====
  const state = {
    mode:'solo',
    playerCount:6,
    roundCount:3,
    bottomPayCount:2,
    teamFinePerPerson:5000,
    teamHandicap:0,
    names:[],
    scores:[],
    teams:{A:[],B:[]},
  };

  // ===== ì—˜ë¦¬ë¨¼íŠ¸ =====
  const els = {
    setupScreen: document.getElementById('setupScreen'),
    gameScreen: document.getElementById('gameScreen'),
    mode: document.getElementById('mode'),
    playerCount: document.getElementById('playerCount'),
    roundCount: document.getElementById('roundCount'),
    bottomPayCount: document.getElementById('bottomPayCount'),
    teamFinePerPerson: document.getElementById('teamFinePerPerson'),
    teamHandicap: document.getElementById('teamHandicap'),
    soloPenaltyRow: document.getElementById('soloPenaltyRow'),
    teamPenaltyRow: document.getElementById('teamPenaltyRow'),
    nameFieldsSolo: document.getElementById('nameFieldsSolo'),
    nameFieldsTeam: document.getElementById('nameFieldsTeam'),
    teamAFields: document.getElementById('teamAFields'),
    teamBFields: document.getElementById('teamBFields'),
    randomTeamsBtn: document.getElementById('randomTeamsBtn'),
    toGameBtn: document.getElementById('toGameBtn'),
    resetSetupBtn: document.getElementById('resetSetupBtn'),
    backToSetupBtn: document.getElementById('backToSetupBtn'),
    resetScoresBtn: document.getElementById('resetScoresBtn'),
    scoreTable: document.getElementById('scoreTable'),
    toggleResultBtn: document.getElementById('toggleResultBtn'),
    saveResultJpgBtn: document.getElementById('saveResultJpgBtn'),
    resultCard: document.getElementById('resultCard'),
    closeResultBtn: document.getElementById('closeResultBtn'),
    liveList: document.getElementById('liveList'),
    settleInfo: document.getElementById('settleInfo'),
    settleList: document.getElementById('settleList'),
    transferSection: document.getElementById('transferSection'),
    transferList: document.getElementById('transferList'),
    toggleTransferBtn: document.getElementById('toggleTransferBtn'),
  };

  // ===== ìœ í‹¸ =====
  const clamp=(v,min,max)=>Math.min(max,Math.max(min,v));
  function formatKRW(n){const sign=n<0?'-':'';const v=Math.abs(n|0);return sign+v.toString().replace(/\B(?=(\d{3})+(?!\d))/g,',')+'ì›';}
  function hide(el){ el.classList.add('hidden'); }
  function show(el){ el.classList.remove('hidden'); }
  function isHidden(el){ return el.classList.contains('hidden'); }

  // ê¸ˆì•¡ ë¶„ë°° ë§¤ì¹­: payers[{name,amount}], receivers[{name,amount}] â†’ {from,to,amount}[]
  function buildTransfers(payers, receivers){
    const transfers=[];
    let i=0, j=0;
    while(i<payers.length && j<receivers.length){
      let due = payers[i].amount;
      let need = receivers[j].amount;
      if(due<=0){ i++; continue; }
      if(need<=0){ j++; continue; }
      const x = Math.min(due, need);
      transfers.push({from:payers[i].name, to:receivers[j].name, amount:x});
      payers[i].amount -= x;
      receivers[j].amount -= x;
      if(payers[i].amount===0) i++;
      if(receivers[j].amount===0) j++;
    }
    return transfers;
  }

  // ===== ì´ˆê¸°í™” =====
  function initNames(){ state.names = Array.from({length: state.playerCount}, (_,i)=> `í”Œë ˆì´ì–´ ${i+1}`); }
  function initScores(){ state.scores = Array.from({length: state.playerCount}, ()=> Array.from({length: state.roundCount}, ()=> null)); }
  function resetTeamsDefault(){
    const idxs=[...Array(state.playerCount).keys()];
    const half=Math.floor(state.playerCount/2);
    state.teams.A = idxs.slice(0,half);
    state.teams.B = idxs.slice(half);
  }

  // ===== ì´ë¦„ ì„ íƒ UI =====
  function makeSelect(idx,labelText){
    const field=document.createElement('div'); field.className='field';
    const lab=document.createElement('label'); lab.textContent=labelText;
    const sel=document.createElement('select');
    sel.innerHTML = `<option value="">ì„ íƒ</option>` + PRESET_NAMES.map((n,i)=>`<option value="${i}">${n}</option>`).join('');
    sel.addEventListener('change', ()=>{ state.names[idx] = sel.value===''? `í”Œë ˆì´ì–´ ${idx+1}` : PRESET_NAMES[+sel.value]; });
    field.appendChild(lab); field.appendChild(sel);
    return field;
  }

  function renderNameFields(){
    els.nameFieldsSolo.innerHTML=''; els.teamAFields.innerHTML=''; els.teamBFields.innerHTML='';
    if(state.mode==='team'){
      const aCount = Math.ceil(state.playerCount/2);
      const bCount = Math.floor(state.playerCount/2);
      for(let i=0;i<aCount;i++) els.teamAFields.appendChild(makeSelect(i, `AíŒ€ ì´ë¦„.${i+1}`));
      for(let j=0;j<bCount;j++) els.teamBFields.appendChild(makeSelect(aCount+j, `BíŒ€ ì´ë¦„.${j+1}`));
      show(els.nameFieldsTeam); hide(els.nameFieldsSolo);
      state.teams.A = [...Array(aCount).keys()];
      state.teams.B = [...Array(bCount).keys()].map(x=> aCount + x);
    }else{
      for(let i=0;i<state.playerCount;i++) els.nameFieldsSolo.appendChild(makeSelect(i, `ì´ë¦„.${i+1}`));
      hide(els.nameFieldsTeam); els.teamAFields.innerHTML=''; els.teamBFields.innerHTML='';
      show(els.nameFieldsSolo);
    }
  }

  // ===== í™”ë©´ ì „í™˜ =====
  function goToGame(){
    hide(els.setupScreen); show(els.gameScreen);
  }
  function backToSetup(){
    // ê²°ê³¼/ì €ì¥ ë²„íŠ¼ ìƒíƒœë„ ë¦¬ì…‹
    hide(els.resultCard);
    hide(els.transferSection);
    els.toggleResultBtn.textContent='ê²°ê³¼ ë³´ê¸°(ìˆœìœ„+ì •ì‚°)';
    els.saveResultJpgBtn.disabled=true;

    hide(els.gameScreen); show(els.setupScreen);
  }

  // ===== ê³„ì‚° =====
  function sumRow(r){ const arr=state.scores[r].filter(v=>v!==null); if(arr.length===0) return NaN; return arr.reduce((a,b)=>a+b,0); }
  function averageRow(r){ const arr=state.scores[r].filter(v=>v!==null); if(arr.length===0) return NaN; return arr.reduce((a,b)=>a+b,0)/arr.length; }
  function teamSum(teamIdxs){ const s=teamIdxs.map(idx=> sumRow(idx)).filter(v=>!isNaN(v)); return s.length? s.reduce((a,b)=>a+b,0):NaN; }

  // ===== ì ìˆ˜íŒ =====
  function renderTable(){
    const thead=`
      <thead>
        <tr>
          <th style="text-align:left">ì´ë¦„</th>
          ${Array.from({length:state.roundCount},(_,i)=>`<th>ë¼ìš´ë“œ${i+1}</th>`).join('')}
          <th>í•©ê³„</th><th>í‰ê· </th>
        </tr>
      </thead>`;
    const tbody=`
      <tbody>
        ${state.names.map((name,r)=>{
          const sum=sumRow(r), avg=averageRow(r);
          const teamBadge=(state.mode==='team')?(state.teams.A.includes(r)?`<span class="badge A">AíŒ€</span>`:`<span class="badge B">BíŒ€</span>`):'';
          return `<tr data-row="${r}">
            <td style="text-align:left;font-weight:800;display:flex;align-items:center;gap:8px">${name}${state.mode==='team' ? ' Â· '+teamBadge : ''}</td>
            ${state.scores[r].map((v,c)=>{
              const val=(v??'');
              return `<td><input data-r="${r}" data-c="${c}" type="number" inputmode="numeric" min="0" max="300" step="1"
                         value="${val}" style="width:90px;max-width:26vw;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fbfcff;font-size:16px"></td>`;
            }).join('')}
            <td><span class="pill info">${isNaN(sum)?'-':sum}</span></td>
            <td><span class="pill">${isNaN(avg)?'-':avg.toFixed(1)}</span></td>
          </tr>`;
        }).join('')}
      </tbody>`;
    els.scoreTable.innerHTML=thead+tbody;

    els.scoreTable.querySelectorAll('input[type="number"]').forEach(inp=>{
      inp.addEventListener('input',(e)=>{
        const r=+e.target.dataset.r, c=+e.target.dataset.c;
        const raw=e.target.value.trim();
        const val=raw===''? null : Math.max(0,Math.min(300,parseInt(raw)));
        state.scores[r][c]=(val===null? null: val);
        updateRowFooter(r);
        applyTeamRowColors();
      },{passive:true});
    });

    applyTeamRowColors();
  }

  function updateRowFooter(r){
    const sum=sumRow(r), avg=averageRow(r);
    const row=els.scoreTable.querySelector(`tbody tr[data-row="${r}"]`);
    if(!row) return;
    row.querySelectorAll('td').item(state.roundCount+1).innerHTML=`<span class="pill info">${isNaN(sum)?'-':sum}</span>`;
    row.querySelectorAll('td').item(state.roundCount+2).innerHTML=`<span class="pill">${isNaN(avg)?'-':avg.toFixed(1)}</span>`;
  }

  function applyTeamRowColors(){
    if(state.mode!=='team'){
      els.scoreTable.querySelectorAll('tbody tr').forEach(tr=>tr.className='');
      return;
    }
    const A=teamSum(state.teams.A), B=teamSum(state.teams.B);
    const aSize=state.teams.A.length, bSize=state.teams.B.length;
    const hc = +els.teamHandicap.value || +state.teamHandicap || 0;
    const Aadj = (aSize<bSize)? A + hc : A;
    const Badj = (bSize<aSize)? B + hc : B;

    let aClass='row-tie', bClass='row-tie';
    if(!(isNaN(Aadj)&&isNaN(Badj))){
      if(Aadj===Badj){ aClass='row-tie'; bClass='row-tie'; }
      else if(Aadj>Badj){ aClass='row-win'; bClass='row-lose'; }
      else{ aClass='row-lose'; bClass='row-win'; }
    }
    els.scoreTable.querySelectorAll('tbody tr').forEach((tr,i)=>{
      if(state.teams.A.includes(i)) tr.className=aClass;
      else if(state.teams.B.includes(i)) tr.className=bClass;
      else tr.className='row-tie';
    });
  }

  // ===== ê²°ê³¼(ìˆœìœ„+ì •ì‚°+ì´ì²´) =====
  function renderResult(){
    // ìˆœìœ„
    const entries=state.names.map((name,i)=>({i,name,sum:sumRow(i),avg:averageRow(i)}));
    if(state.mode==='team'){
      const A=teamSum(state.teams.A), B=teamSum(state.teams.B);
      const aSize=state.teams.A.length, bSize=state.teams.B.length;
      const hc = state.teamHandicap;
      const Aadj = (aSize<bSize)? A + hc : A;
      const Badj = (bSize<aSize)? B + hc : B;
      const leader=(isNaN(Aadj)&&isNaN(Badj))?'ì ìˆ˜ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”':(Aadj===Badj?'ë™ì !':(Aadj>Badj?'AíŒ€ ë¦¬ë“œ':'BíŒ€ ë¦¬ë“œ'));

      els.liveList.innerHTML=`
        <div class="line">
          <div><div class="name">AíŒ€ í•©ê³„${(aSize<bSize&&hc>0)?' (+í•¸ë””ìº¡)':''}</div><div class="sub">${state.teams.A.map(i=>state.names[i]).join(' Â· ')||'-'}</div></div>
          <div class="pill info" style="font-weight:900">${isNaN(Aadj)?'-':Aadj}</div>
        </div>
        <div class="line">
          <div><div class="name">BíŒ€ í•©ê³„${(bSize<aSize&&hc>0)?' (+í•¸ë””ìº¡)':''}</div><div class="sub">${state.teams.B.map(i=>state.names[i]).join(' Â· ')||'-'}</div></div>
          <div class="pill info" style="font-weight:900">${isNaN(Badj)?'-':Badj}</div>
        </div>
        <div class="line" style="justify-content:center"><span class="pill ${leader.includes('ë¦¬ë“œ')?'good':''}">${leader}</span></div>
      `;
    }else{
      const valid=entries.filter(e=>!isNaN(e.sum));
      valid.sort((a,b)=>{
        if(b.sum!==a.sum) return b.sum-a.sum;
        if(isNaN(a.avg)&&isNaN(b.avg)) return 0;
        if(isNaN(a.avg)) return 1;
        if(isNaN(b.avg)) return -1;
        return b.avg-a.avg;
      });

      els.liveList.innerHTML = valid.map((e,idx)=>{
        const medal = idx===0?'ğŸ¥‡':idx===1?'ğŸ¥ˆ':idx===2?'ğŸ¥‰':'';
        return `
        <div class="line">
          <div style="display:flex;align-items:center;gap:10px">
            <span class="rank">${idx+1}</span>
            <div>
              <div class="name">${medal? medal+' ':''}${e.name}</div>
              <div class="sub">í•©ê³„ ${e.sum}${isNaN(e.avg)?'':` Â· í‰ê·  ${e.avg.toFixed(1)}`}</div>
            </div>
          </div>
          <div class="pill ${idx===0?'good':''}">${idx===0?'TOP':''}</div>
        </div>`;
      }).join('') || `<div class="sub">ì ìˆ˜ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”</div>`;
    }

    // ì •ì‚° + ì´ì²´ ì•ˆë‚´
    if(state.mode==='team'){
      const A=teamSum(state.teams.A), B=teamSum(state.teams.B);
      const aSize=state.teams.A.length, bSize=state.teams.B.length;
      const hc = state.teamHandicap;
      const Aadj = (aSize<bSize)? A + hc : A;
      const Badj = (bSize<aSize)? B + hc : B;

      els.settleList.innerHTML=''; els.transferList.innerHTML='';

      if(isNaN(Aadj)&&isNaN(Badj)){ els.settleInfo.textContent='ì ìˆ˜ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'; return; }
      if(Aadj===Badj){ els.settleInfo.textContent='ë™ì ì…ë‹ˆë‹¤. íŒ¨ë°° íŒ€ ì—†ìŒ.'; return; }

      const loserTeam = (Aadj>Badj)? 'B':'A';
      const loserIdxs = loserTeam==='A'? state.teams.A : state.teams.B;
      const winnerIdxs = loserTeam==='A'? state.teams.B : state.teams.A;
      const eachPay = Math.max(0, state.teamFinePerPerson|0);
      const pot = loserIdxs.length * eachPay;
      const winnersCount = winnerIdxs.length;

      const baseGet = winnersCount>0 ? Math.floor(pot / winnersCount) : 0;
      let remainder = winnersCount>0 ? pot % winnersCount : 0;

      els.settleInfo.textContent = `${loserTeam}íŒ€ íŒ¨ë°° Â· íŒ¨ë°° íŒ€ ê°ì ${formatKRW(eachPay)} ë‚©ë¶€ Â· ìŠ¹ë¦¬ íŒ€ ê°ì ì•½ ${formatKRW(baseGet)} ìˆ˜ë ¹`;

      const items=[];
      loserIdxs.forEach(i=> items.push({name:state.names[i], tag:`${loserTeam}íŒ€`, amount:-eachPay}));
      winnerIdxs.forEach((i,idx)=>{
        const extra = (remainder>0)? 1:0; if(remainder>0) remainder--;
        items.push({name:state.names[i], tag:(loserTeam==='A'?'B':'A')+'íŒ€', amount:+(baseGet+extra)});
      });
      els.settleList.innerHTML = items.map(o=>`
        <div class="line">
          <div><div class="name">${o.name}</div><div class="sub">${o.tag}</div></div>
          <div class="pill ${o.amount>=0?'good':'bad'}">${o.amount>=0?'+':''}${formatKRW(o.amount)}</div>
        </div>
      `).join('');

      // ì´ì²´ ë§¤ì¹­
      const payers = loserIdxs.map(i=>({name:state.names[i], amount:eachPay}));
      const receivers = winnerIdxs.map((i)=>({
        name:state.names[i],
        amount: items.find(x=>x.name===state.names[i]).amount
      }));
      const transfers = buildTransfers(payers, receivers);
      els.transferList.innerHTML = transfers.map(t=>`
        <div class="line">
          <div><div class="name">${t.from}</div><div class="sub">â†’ ${t.to}</div></div>
          <div class="pill bad">-${formatKRW(t.amount)}</div>
        </div>
      `).join('');

    }else{
      // ê°œì¸ì „: ìŠ¹ì +5,000, íŒ¨ìê°€ ì´ì•¡ ê· ë“± ë¶€ë‹´ â†’ ì´ì²´ëŠ” íŒ¨ì â†’ ìŠ¹ì
      const ranked = state.names.map((name,i)=>({i,name,sum:sumRow(i),avg:averageRow(i)})).filter(e=>!isNaN(e.sum));
      const N=ranked.length;
      if(N===0){ els.settleInfo.textContent='ì ìˆ˜ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'; els.settleList.innerHTML=''; els.transferList.innerHTML=''; return; }

      // í•˜ìœ„ Lëª…
      const L=Math.min(state.bottomPayCount, Math.max(1,N-1));
      ranked.sort((a,b)=>{
        if(a.sum!==b.sum) return a.sum-b.sum;
        if(isNaN(a.avg)&&isNaN(b.avg)) return 0;
        if(isNaN(a.avg)) return 1;
        if(isNaN(b.avg)) return -1;
        return a.avg-b.avg;
      });
      const losersIdx = ranked.slice(0,L).map(e=>e.i);
      const winnersIdx = ranked.slice(L).map(e=>e.i);
      const winnersCount = winnersIdx.length;

      const totalPayout = winnersCount * SOLO_WINNER_BONUS;
      const baseLoserPay = Math.floor(totalPayout / L);
      let remainder = totalPayout % L;

      els.settleInfo.textContent = `ìŠ¹ì ${winnersCount}ëª… ê° +${formatKRW(SOLO_WINNER_BONUS)} Â· íŒ¨ì ${L}ëª… í•©ê³„ ${formatKRW(totalPayout)} ê· ë“± ë¶„ë‹´`;

      // ê°œë³„ ì •ì‚°í‘œ
      const items=[];
      winnersIdx.forEach(i=> items.push({name:state.names[i], tag:'ìƒìœ„', amount:+SOLO_WINNER_BONUS}));
      losersIdx.forEach((i,idx)=>{
        const extra = (remainder>0)? 1:0; if(remainder>0) remainder--;
        items.push({name:state.names[i], tag:'í•˜ìœ„', amount:-(baseLoserPay+extra)});
      });
      els.settleList.innerHTML = items.map(o=>`
        <div class="line">
          <div><div class="name">${o.name}</div><div class="sub">${o.tag}</div></div>
          <div class="pill ${o.amount>=0?'good':'bad'}">${o.amount>=0?'+':''}${formatKRW(o.amount)}</div>
        </div>
      `).join('');

      // ì´ì²´ ë§¤ì¹­: íŒ¨ì â†’ ìŠ¹ì
      const payers = losersIdx.map(i=>{
        const amt = Math.abs(items.find(x=>x.name===state.names[i]).amount);
        return {name:state.names[i], amount:amt};
      });
      const receivers = winnersIdx.map(i=>({name:state.names[i], amount:SOLO_WINNER_BONUS}));
      const transfers = buildTransfers(payers, receivers);
      els.transferList.innerHTML = transfers.map(t=>`
        <div class="line">
          <div><div class="name">${t.from}</div><div class="sub">â†’ ${t.to}</div></div>
          <div class="pill bad">-${formatKRW(t.amount)}</div>
        </div>
      `).join('');
    }
  }

  // ===== JPG ì €ì¥(ê²°ê³¼ íŒ¨ë„ë§Œ) =====
  async function saveResultAsJPG(){
    if(isHidden(els.resultCard)) return;
    const canvas=await html2canvas(els.resultCard,{scale:2,backgroundColor:'#ffffff',useCORS:true,logging:false});
    const dataUrl=canvas.toDataURL('image/jpeg',0.92);
    const a=document.createElement('a');
    a.href=dataUrl; a.download=`bowling_result_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.jpg`;
    document.body.appendChild(a); a.click(); a.remove();
  }

  // ===== ì´ë²¤íŠ¸ =====
  // ëª¨ë“œ ì „í™˜
  els.mode.addEventListener('change', ()=>{
    state.mode = els.mode.value;
    els.soloPenaltyRow.classList.toggle('hidden', state.mode==='team');
    els.teamPenaltyRow.classList.toggle('hidden', state.mode!=='team');
    renderNameFields();
  });

  // ì¸ì› ë³€ê²½
  els.playerCount.addEventListener('input', ()=>{
    state.playerCount = clamp(+els.playerCount.value,2,16);
    initNames(); renderNameFields();
  });

  // íŒ€ ëœë¤
  els.randomTeamsBtn && els.randomTeamsBtn.addEventListener('click', ()=>{
    const idxs=[...Array(state.playerCount).keys()];
    for(let i=idxs.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [idxs[i],idxs[j]]=[idxs[j],idxs[i]]; }
    const aCount = Math.ceil(state.playerCount/2);
    state.teams.A = idxs.slice(0,aCount);
    state.teams.B = idxs.slice(aCount);
    alert('íŒ€ì´ ëœë¤ìœ¼ë¡œ ë°°ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ê° íŒ€ ì¹¸ì—ì„œ ì´ë¦„ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
  });

  // ì„¤ì • ì´ˆê¸°í™”
  els.resetSetupBtn.addEventListener('click', ()=>{
    els.mode.value='solo'; state.mode='solo';
    els.playerCount.value=6; els.roundCount.value=3;
    els.bottomPayCount.value=2;
    els.teamFinePerPerson.value=5000; els.teamHandicap.value=0;
    state.playerCount=6; state.roundCount=3; state.bottomPayCount=2;
    state.teamFinePerPerson=5000; state.teamHandicap=0;
    initNames(); resetTeamsDefault(); renderNameFields();
    els.soloPenaltyRow.classList.remove('hidden'); els.teamPenaltyRow.classList.add('hidden');
  });

  // ì„¤ì • í™•ì¸ â†’ ê²Œì„ í™”ë©´
  els.toGameBtn.addEventListener('click', ()=>{
    state.mode=els.mode.value;
    state.playerCount=clamp(+els.playerCount.value,2,16);
    state.roundCount=clamp(+els.roundCount.value,1,10);
    state.bottomPayCount=Math.max(1,Math.min(state.playerCount-1,+els.bottomPayCount.value||1));
    state.teamFinePerPerson=Math.max(0,+els.teamFinePerPerson.value||0);
    state.teamHandicap=Math.max(0,+els.teamHandicap.value||0);

    initScores(); renderTable(); goToGame();

    // ê²°ê³¼/ì €ì¥ ë²„íŠ¼ ìƒíƒœ ë¦¬ì…‹
    hide(els.resultCard);
    els.toggleResultBtn.textContent='ê²°ê³¼ ë³´ê¸°(ìˆœìœ„+ì •ì‚°)';
    els.saveResultJpgBtn.disabled=true;
    hide(els.transferSection);
    els.toggleTransferBtn.textContent='ì´ì²´ ì•ˆë‚´ ë³´ê¸°';
  });

  // ì„¤ì • ë‹¤ì‹œí•˜ê¸° (ë²„íŠ¼ ê³ ì¥ ë°©ì§€: í™•ì‹¤íˆ ë™ì‘í•˜ë„ë¡ ìƒíƒœ/ë·° ëª¨ë‘ ë¦¬ì…‹)
  els.backToSetupBtn.addEventListener('click', backToSetup);

  // ì ìˆ˜ ì´ˆê¸°í™” (ë²„íŠ¼ ê³ ì¥ ë°©ì§€: ì ìˆ˜/ë·°/ê²°ê³¼ ëª¨ë‘ ë¦¬ì…‹)
  els.resetScoresBtn.addEventListener('click', ()=>{
    initScores(); renderTable();
    hide(els.resultCard);
    els.toggleResultBtn.textContent='ê²°ê³¼ ë³´ê¸°(ìˆœìœ„+ì •ì‚°)';
    els.saveResultJpgBtn.disabled=true;
    hide(els.transferSection);
    els.toggleTransferBtn.textContent='ì´ì²´ ì•ˆë‚´ ë³´ê¸°';
  });

  // ê²°ê³¼ ì—´ê³ /ë‹«ê¸° + ì €ì¥ ë²„íŠ¼ ìƒíƒœ
  els.toggleResultBtn.addEventListener('click', ()=>{
    const open = isHidden(els.resultCard);
    if(open){
      renderResult();
      show(els.resultCard);
      els.toggleResultBtn.textContent='ê²°ê³¼ ë‹«ê¸°';
      els.saveResultJpgBtn.disabled=false;
    }else{
      hide(els.resultCard);
      els.toggleResultBtn.textContent='ê²°ê³¼ ë³´ê¸°(ìˆœìœ„+ì •ì‚°)';
      els.saveResultJpgBtn.disabled=true;
    }
  });
  els.closeResultBtn.addEventListener('click', ()=>{ els.toggleResultBtn.click(); });
  els.saveResultJpgBtn.addEventListener('click', saveResultAsJPG);

  // ì´ì²´ ì•ˆë‚´ í† ê¸€
  els.toggleTransferBtn.addEventListener('click', ()=>{
    if(isHidden(els.transferSection)){
      show(els.transferSection);
      els.toggleTransferBtn.textContent='ì´ì²´ ì•ˆë‚´ ìˆ¨ê¸°ê¸°';
    }else{
      hide(els.transferSection);
      els.toggleTransferBtn.textContent='ì´ì²´ ì•ˆë‚´ ë³´ê¸°';
    }
  });

  // ===== ë¶€íŠ¸ìŠ¤íŠ¸ë© =====
  (function bootstrap(){
    state.mode = els.mode.value;
    initNames(); resetTeamsDefault(); renderNameFields();
  })();
</script>
</body>
</html>
